name: CI/CD Pipeline

# Se activa cuando haces push a la rama main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Variables de entorno globales
env:
  PYTHONPATH: .

permissions:
  contents: read
  packages: write
jobs:
  # --- PASOS 1, 2 y 3: CALIDAD (Lint y Tests) ---
  check-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Bajar el código
        uses: actions/checkout@v3

      - name: Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Instalar dependencias
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8 httpx

      - name: Paso 1 - Linting (Calidad de código)
        run: |
          # Detiene el build si hay errores de sintaxis o nombres indefinidos
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Advertencias de estilo (exit-zero trata todos los errores como advertencias)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Paso 2 - Pruebas Unitarias
        run: |
          cd backend/to_do_project
          python -m pytest tests/unit/ -v

      - name: Paso 3 - Pruebas de Integración
        run: |
          cd backend/to_do_project
          python -m pytest tests/integration/ -v

  # --- PASO 4: BUILD (Construir Imagen Docker) ---
  build-and-push:
    needs: check-quality # Solo corre si los tests pasaron
    runs-on: ubuntu-latest
    steps:
      - name: Bajar el código
        uses: actions/checkout@v3

      - name: Login en GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extraer metadatos (tags, labels) para Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ghcr.io/${{ github.repository }}

      - name: Construir y Subir Imagen (Build & Push)
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # --- PASO 5: DEPLOY (Simulación) ---
  deploy:
    needs: build-and-push # Solo corre si la imagen se construyó correctamente
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Simular Despliegue
        run: |
          echo "Conectando al servidor de producción..."
          echo "Descargando la imagen ghcr.io/${{ github.repository }}:main..."
          echo "Reiniciando servicio..."
          echo "¡Despliegue exitoso!"